<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="statistics">
  <select id="selectPeriodStatistics" resultType="periodStatisticVo">
  	SELECT *
	FROM v_period_statistics_paid
		left JOIN v_period_statistics_cancel USING(paid_at)
	<where>
		<if test='type == "D"'>
			DATE(paid_at) = DATE(#{date})
		</if>
		<if test='type == "M"'>
			MONTH(paid_at) = MONTH(#{date})
		</if>
		<if test='type == "Y"'>
			YEAR(paid_at) = YEAR(#{date})
		</if>
	</where>	
  </select>

  <select id="selectProductStatistics" parameterType="hashmap" resultType="productStatisticVo">
	SELECT *,
	(SELECT count(amount)
	 FROM v_product_statistics
	 WHERE order_status_no >= 2) paymentCount,
	 (SELECT COUNT(amount)
	 FROM v_product_statistics
	 WHERE order_status_no = 7) returnCount,
	 (SELECT SUM(amount)
	 FROM v_product_statistics
	 WHERE order_status_no >= 2) paymentSum,
	 (ROW_NUMBER() over(ORDER BY (SELECT
		 						   COUNT(amount)
		 						   FROM v_product_statistics
		 						   WHERE order_status_no >= 2
		 						   AND   order_status_no != 7) DESC)) AS productRank
	 FROM v_product_statistics
	 <if test="search.start_date != null and search.end_date">
	 	WHERE reg_date between #{search.start_date} and #{search.end_date}
	 </if>
	 ORDER BY productRank ASC
  </select>  
  
  <select id="selectMemberStatisticsList" resultType="MemberStatisticVo">
  SELECT NAME, id, SUM(amount) AS total_amount, SUM(cancel_amount) AS total_amount_cancel, (sum(amount) - sum(ifnull(cancel_amount,0))) AS total, RANK() over(ORDER BY total DESC) AS ranking, COUNT(amount) AS order_cnt, COUNT(cancel_amount) AS cancel_cnt
	FROM v_member_statistics_paid 
		LEFT JOIN v_member_statistics_cancel USING(member_no)
	
	WHERE paid_at <![CDATA[ <=]]> #{endDate} and paid_at <![CDATA[ >=]]> #{startDate}
	
		OR cancel_at <![CDATA[ <=]]> #{endDate} and cancel_at <![CDATA[ >=]]> #{startDate}
	
	GROUP BY member_no
	
	ORDER BY ranking LIMIT 10
  </select>
  
</mapper>